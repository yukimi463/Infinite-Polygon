<body>
    <div class="total-counter" id="totalCounter">所持金: 0</div>
    <h1>クリッカーゲーム</h1>
    <div id="gameWrapper" style="display: flex; flex-direction: row; align-items: center;">
        <!-- 多角形はここに追加される -->
    </div>
    <div style="margin-top:24px;">
        <button id="evolveBtn" class="auto-btn" disabled>進化する（コスト: <span id="evolveCostText">10</span>）</button>
        <button id="powerupBtn" class="auto-btn" disabled>強化する（Lv.<span id="powerupLevelText">0</span> コスト: <span id="powerupCostText">1</span>）</button>
        <button id="autoBtn" class="auto-btn" disabled>オートカウント（所持金100で解放）</button>
    </div>
    <style>
        .polygon-wrapper {
            position: relative;
            width: 260px;
            height: 260px;
            margin-left: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .polygon-name {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        .polygon {
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #fff;
            background: #2196f3;
            user-select: none;
            transition: 0.2s;
            position: relative;
        }
        .polygon:active {
            background: #1976d2;
        }
        .vertex-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ffeb3b;
            border-radius: 50%;
            border: 2px solid #333;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 2;
        }
    </style>
    <script>
        function getPolygonPoints(sides) {
            const points = [];
            const coords = [];
            for (let i = 0; i < sides; i++) {
                const angle = (2 * Math.PI * i) / sides - Math.PI / 2;
                const x = 50 + 48 * Math.cos(angle);
                const y = 50 + 48 * Math.sin(angle);
                points.push(`${x}% ${y}%`);
                coords.push({ x: x, y: y });
            }
            return { 
                clipPath: `polygon(${points.join(', ')})`,
                coords: coords
            };
        }

        let sides = 3;
        let count = 0;
        let totalCount = 0; // 通貨
        let clickValue = 1;
        let evolveCost = 10;
        let autoCounting = false;
        let autoInterval = null;

        // 強化関連
        let powerupLevel = 0;
        let powerupCost = Math.floor(evolveCost / 10);

        const gameWrapper = document.getElementById('gameWrapper');
        const totalCounter = document.getElementById('totalCounter');
        const autoBtn = document.getElementById('autoBtn');
        const evolveBtn = document.getElementById('evolveBtn');
        const evolveCostText = document.getElementById('evolveCostText');
        const powerupBtn = document.getElementById('powerupBtn');
        const powerupCostText = document.getElementById('powerupCostText');
        const powerupLevelText = document.getElementById('powerupLevelText');
        let polygonDiv;

        function adjustFontSize(element, value) {
            // 桁数に応じてフォントサイズを調整
            let length = String(value).length;
            let baseSize = 3; // rem
            let size = baseSize;
            if (length >= 7) size = 1.5;
            else if (length >= 5) size = 2;
            else if (length >= 3) size = 2.5;
            element.style.fontSize = size + "rem";
        }

        function createPolygon(sides, count, isMini = false, miniClickValue = 1) {
            const wrapper = document.createElement('div');
            wrapper.className = 'polygon-wrapper';

            const name = document.createElement('div');
            name.className = 'polygon-name';
            name.textContent = isMini ? `正${sides}角形(ミニ)` : `正${sides}角形`;
            wrapper.appendChild(name);

            const { clipPath, coords } = getPolygonPoints(sides);

            const polygon = document.createElement('div');
            polygon.className = 'polygon';
            polygon.style.clipPath = clipPath;
            polygon.style.background = isMini
                ? `hsl(${200 + sides * 20}, 70%, 80%)`
                : `hsl(${200 + sides * 20}, 70%, 55%)`;
            polygon.textContent = count;
            adjustFontSize(polygon, count);

            // サイズ調整（ミニの場合は3分の1）
            if (isMini) {
                polygon.style.width = "66px";
                polygon.style.height = "66px";
                polygon.style.fontSize = "1rem";
                wrapper.style.width = "86px";
                wrapper.style.height = "86px";
                name.style.fontSize = "0.7rem";
                name.style.marginBottom = "4px";
            }

            wrapper.appendChild(polygon);

            coords.forEach(pt => {
                const dot = document.createElement('div');
                dot.className = 'vertex-dot';
                dot.style.left = isMini ? `${pt.x * 0.66}px` : `${pt.x * 2}px`;
                dot.style.top = isMini ? `${pt.y * 0.66}px` : `${pt.y * 2}px`;
                polygon.appendChild(dot);
            });

            // ミニ多角形のクリックイベント
            if (isMini) {
                polygon.addEventListener('click', function(e) {
                    count += miniClickValue;
                    polygon.textContent = count;
                    adjustFontSize(polygon, count);
                    totalCount += miniClickValue;
                    updateTotalCounter();
                    updateEvolveBtn();
                    updatePowerupBtn();
                    checkAutoUnlock();
                    e.stopPropagation();
                });
            }

            return wrapper;
        }

        function updatePolygonValue() {
            const polygon = polygonDiv.querySelector('.polygon');
            polygon.textContent = count;
            adjustFontSize(polygon, count); // 追加
        }

        function updateTotalCounter() {
            totalCounter.textContent = `所持金: ${totalCount}`;
        }
        function updateEvolveBtn() {
            evolveBtn.disabled = totalCount < evolveCost;
            evolveCostText.textContent = evolveCost;
        }
        function updatePowerupBtn() {
            powerupBtn.disabled = totalCount < powerupCost;
            powerupCostText.textContent = powerupCost;
            powerupLevelText.textContent = powerupLevel;
        }

        let miniUnlock = false; // ミニ生成解放フラグ

        function handleClick() {
            count += clickValue;
            totalCount += clickValue;
            updatePolygonValue();
            updateTotalCounter();
            updateEvolveBtn();
            updatePowerupBtn();
            checkAutoUnlock();
            checkMiniUnlock(); // ←追加

            // ミニ生成機能が解放されていれば生成
            if (miniUnlock && Math.random() < 0.01) {
                const miniDiv = createPolygon(
                    sides,
                    0,
                    true,
                    Math.max(1, Math.floor(clickValue / 3))
                );
                gameWrapper.appendChild(miniDiv);
            }
        }

        // 所持金でミニ解放判定
        function checkMiniUnlock() {
            if (!miniUnlock && totalCount >= 1000) {
                miniUnlock = true;
                // 必要なら通知など追加
                alert("ミニ正n角形生成機能が解放されました！");
            }
        }

        function autoCount() {
            handleClick();
        }

        function checkAutoUnlock() {
            if (totalCount >= 100 && autoBtn.disabled) {
                autoBtn.disabled = false;
                autoBtn.textContent = "オートカウントON";
            }
        }

        autoBtn.addEventListener('click', function() {
            if (autoCounting) {
                autoCounting = false;
                clearInterval(autoInterval);
                autoInterval = null;
                autoBtn.textContent = "オートカウントON";
            } else {
                autoCounting = true;
                autoInterval = setInterval(autoCount, 1000);
                autoBtn.textContent = "オートカウントOFF";
            }
        });

        evolveBtn.addEventListener('click', function() {
            if (totalCount >= evolveCost) {
                sides++;
                clickValue *= 2;
                totalCount -= evolveCost;
                count = 0;
                evolveCost *= 10;
                powerupCost = Math.floor(evolveCost / 10); // 強化コストも更新
                const newPolygon = createPolygon(sides, count);
                gameWrapper.replaceChild(newPolygon, polygonDiv);
                polygonDiv = newPolygon;
                polygonDiv.querySelector('.polygon').addEventListener('click', handleClick);
                updateTotalCounter();
                updateEvolveBtn();
                updatePowerupBtn();
            }
        });

        powerupBtn.addEventListener('click', function() {
            if (totalCount >= powerupCost) {
                powerupLevel++;
                totalCount -= powerupCost;
                clickValue = Math.floor(clickValue * 1.5);
                powerupCost = Math.floor(powerupCost * 1.1);
                updateTotalCounter();
                updatePowerupBtn();
                updateEvolveBtn();
            }
        });

        polygonDiv = createPolygon(sides, count);
        gameWrapper.appendChild(polygonDiv);
        updateTotalCounter();
        updateEvolveBtn();
        updatePowerupBtn();

        polygonDiv.querySelector('.polygon').addEventListener('click', handleClick);
    </script>
</body>
</html>